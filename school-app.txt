import os
from datetime import datetime
from flask import Flask, render_template_string, request, redirect, url_for
from flask_sqlalchemy import SQLAlchemy

# ==========================================
# 1. Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙˆÙ‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
# ==========================================
app = Flask(__name__)
# Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª SQLite Ù…Ø­Ù„ÙŠØ© (Ù…Ù„Ù ÙˆØ§Ø­Ø¯)
app.config['SQLALCHEMY_DATABASE_URI'] = 'sqlite:///school_quality.db'
app.config['SQLALCHEMY_TRACK_MODIFICATIONS'] = False
app.secret_key = 'secret_key_for_session'

db = SQLAlchemy(app)

# ==========================================
# 2. Ù‡ÙŠÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Models) - Ù…Ø·Ø§Ø¨Ù‚ Ù„Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø±ÙÙ‚
# ==========================================

# Ø§Ù„Ø«ÙˆØ§Ø¨Øª (Ø§Ù„Ø£Ù‚Ø³Ø§Ù… ÙˆØ§Ù„Ù…Ù†Ø§ØµØ¨)
DEPARTMENTS = {
    'AR': 'Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©',
    'MATH_SC': 'Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª ÙˆØ§Ù„Ø¹Ù„ÙˆÙ…',
    'ENG': 'Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©',
    'ISLAMIC': 'Ø§Ù„ØªØ±Ø¨ÙŠØ© Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠØ©',
    'SOC': 'Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ©',
    'CLASS_SYS': 'Ù†Ø¸Ø§Ù… ÙØµÙ„',
    'ENRICH': 'Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø¥Ø«Ø±Ø§Ø¦ÙŠØ©',
    'SPORT': 'Ø§Ù„ØªØ±Ø¨ÙŠØ© Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ©'
}

ROLES = {
    'PRINCIPAL': 'Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø¯Ø±Ø³Ø©',
    'ASST_PRIN': 'Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯',
    'SENIOR_T': 'Ù…Ø¹Ù„Ù… Ø£ÙˆÙ„ / Ù…Ù†Ø³Ù‚'
}

RATINGS = {
    4: 'ÙŠÙÙˆÙ‚ Ø§Ù„ØªÙˆÙ‚Ø¹Ø§Øª Ø¨ÙƒØ«ÙŠØ±',
    3: 'ÙŠÙÙˆÙ‚ Ø§Ù„ØªÙˆÙ‚Ø¹Ø§Øª',
    2: 'ÙŠÙÙŠ Ø¨Ø§Ù„ØªÙˆÙ‚Ø¹Ø§Øª',
    1: 'ÙŠÙÙŠ Ø¨Ø§Ù„ØªÙˆÙ‚Ø¹Ø§Øª Ø¬Ø²Ø¦ÙŠØ§Ù‹'
}

# Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ†
class Teacher(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    name = db.Column(db.String(100), nullable=False)
    department = db.Column(db.String(20), nullable=False) # Code from DEPARTMENTS

# Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„ØµÙÙŠØ© 
class Visit(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    visitor_name = db.Column(db.String(100))
    visitor_role = db.Column(db.String(20)) # Code from ROLES
    teacher_id = db.Column(db.Integer, db.ForeignKey('teacher.id'))
    teacher = db.relationship('Teacher', backref='visits')
    date = db.Column(db.Date, default=datetime.utcnow)
    rating = db.Column(db.Integer) # 1 to 4
    notes = db.Column(db.Text, nullable=True)

# Ø¬Ø¯ÙˆÙ„ Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ù‚ÙŠØ§Ø¯Ø© Ø§Ù„Ø¹Ù„ÙŠØ§ Ù„Ù„ÙˆØ³Ø·Ù‰ 
class MiddleLeadershipTracking(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    department = db.Column(db.String(20), unique=True)
    visit_forms_count = db.Column(db.Integer, default=0)
    has_meeting_minutes = db.Column(db.Boolean, default=False)
    has_weekly_plan = db.Column(db.Boolean, default=False)
    reason_for_missing = db.Column(db.String(200), default="")

# Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù†ÙˆØ¹ÙŠ 
class QualitativeReport(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    department = db.Column(db.String(20))
    strengths = db.Column(db.Text, default="")
    improvements = db.Column(db.Text, default="")

# ==========================================
# 3. Ù‚ÙˆØ§Ù„Ø¨ HTML (Ù…Ø¯Ù…Ø¬Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯ Ù„Ù„Ø³Ù‡ÙˆÙ„Ø©)
# ==========================================

# Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ø¹Ø§Ù… ÙˆÙ„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
DASHBOARD_TEMPLATE = """
<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <title>Ù†Ø¸Ø§Ù… Ø¬ÙˆØ¯Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…</title>
    <style>
        body { font-family: Tahoma, sans-serif; background: #f4f4f4; padding: 20px; }
        .container { max-width: 800px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px #ccc; }
        h1 { color: #2c3e50; text-align: center; }
        .btn { display: inline-block; padding: 10px 20px; margin: 5px; background: #3498db; color: white; text-decoration: none; border-radius: 5px; }
        .btn-green { background: #27ae60; }
        .btn-red { background: #c0392b; }
        form { margin-top: 20px; border-top: 1px solid #eee; padding-top: 20px; }
        input, select, textarea { width: 100%; padding: 10px; margin: 5px 0; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;}
    </style>
</head>
<body>
    <div class="container">
        <h1>Ù†Ø¸Ø§Ù… ØªØªØ¨Ø¹ Ø¬ÙˆØ¯Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ… ÙˆØ§Ù„ØªØ¹Ù„Ù…</h1>
        <div style="text-align: center;">
            <a href="{{ url_for('report_view') }}" class="btn btn-green" target="_blank">ğŸ“„ Ø¹Ø±Ø¶ ÙˆØ·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø±Ø³Ù…ÙŠ</a>
            <a href="{{ url_for('setup_data') }}" class="btn btn-red">âš ï¸ Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· / Ø¥Ø¶Ø§ÙØ© Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ©</a>
        </div>

        <h3>ØªØ³Ø¬ÙŠÙ„ Ø²ÙŠØ§Ø±Ø© ØµÙÙŠØ© Ø¬Ø¯ÙŠØ¯Ø©:</h3>
        <form method="POST" action="{{ url_for('add_visit') }}">
            <label>Ø§Ø³Ù… Ø§Ù„Ø²Ø§Ø¦Ø±:</label>
            <input type="text" name="visitor_name" required>
            
            <label>ØµÙØ© Ø§Ù„Ø²Ø§Ø¦Ø±:</label>
            <select name="visitor_role">
                {% for code, name in roles.items() %}
                <option value="{{ code }}">{{ name }}</option>
                {% endfor %}
            </select>

            <label>Ø§Ù„Ù…Ø¹Ù„Ù… (Ø§Ø®ØªØ± Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø£Ùˆ Ø³ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¤Ù‡):</label>
            <select name="teacher_id" required>
                {% for t in teachers %}
                <option value="{{ t.id }}">{{ t.name }} - {{ depts[t.department] }}</option>
                {% endfor %}
            </select>

            <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø²ÙŠØ§Ø±Ø©:</label>
            <input type="date" name="date" required>

            <label>Ø§Ù„ØªÙ‚ÙŠÙŠÙ…:</label>
            <select name="rating">
                {% for score, text in ratings.items() %}
                <option value="{{ score }}">{{ score }} - {{ text }}</option>
                {% endfor %}
            </select>

            <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ù„Ù„Ù…Ø¹Ù„Ù… Ø§Ù„Ø£ÙˆÙ„Ù‰ Ø¨Ø§Ù„Ø±Ø¹Ø§ÙŠØ©):</label>
            <textarea name="notes"></textarea>

            <button type="submit" class="btn">Ø­ÙØ¸ Ø§Ù„Ø²ÙŠØ§Ø±Ø©</button>
        </form>
    </div>
</body>
</html>
"""

# Ù‚Ø§Ù„Ø¨ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø±Ø³Ù…ÙŠ (Ù…Ø·Ø§Ø¨Ù‚ Ù„Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø±ÙÙ‚ 100%)
REPORT_TEMPLATE = """
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>ØªÙ‚Ø±ÙŠØ± ØªØªØ¨Ø¹ Ø§Ù„Ø¬ÙˆØ¯Ø©</title>
    <style>
        @page { size: A4; margin: 1cm; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; font-size: 11px; margin: 0; }
        
        /* Header Styles */
        .header-container { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 2px solid #ccc; padding-bottom: 10px; }
        .logo-text { text-align: center; font-weight: bold; }
        
        .report-title-box { text-align: center; border: 2px solid #000; padding: 10px; margin: 10px 0; background: #f9f9f9; }
        .report-title-box h2 { margin: 5px 0; font-size: 16px; }

        /* Table Styles to match Word Document */
        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; page-break-inside: avoid; }
        th, td { border: 1px solid #000; padding: 4px; text-align: center; vertical-align: middle; }
        th { background-color: #e6e6e6; font-weight: bold; }
        
        .section-header { background-color: #d9d9d9; padding: 5px; font-weight: bold; margin-top: 15px; border: 1px solid #000; margin-bottom: 5px; }

        .align-right { text-align: right; }
        
        @media print {
            .no-print { display: none; }
            button { display: none; }
        }
    </style>
</head>
<body>

    <button onclick="window.print()" style="padding: 10px; background: blue; color: white; width: 100%; font-size: 16px;">Ø§Ø¶ØºØ· Ù‡Ù†Ø§ Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ± / Ø­ÙØ¸ PDF</button>

    <div class="header-container">
        <div class="logo-text">Ministry of Education<br>Kingdom of Bahrain</div>
        <div class="logo-text">ÙˆØ²Ø§Ø±Ø© Ø§Ù„ØªØ±Ø¨ÙŠØ© ÙˆØ§Ù„ØªØ¹Ù„ÙŠÙ…<br>Ù…Ù…Ù„ÙƒØ© Ø§Ù„Ø¨Ø­Ø±ÙŠÙ†</div>
    </div>

    <div class="report-title-box">
        <h2>ØªÙ‚Ø±ÙŠØ± Ù…ØªØ§Ø¨Ø¹Ø© Ø¬ÙˆØ¯Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ… ÙˆØ§Ù„ØªØ¹Ù„Ù… Ù„Ù„Ù‚ÙŠØ§Ø¯Ø© Ø§Ù„Ø¹Ù„ÙŠØ§ ÙˆØ§Ù„ÙˆØ³Ø·Ù‰</h2>
        <p>Ù„Ù…Ø¯Ø±Ø³Ø©: <b>Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠØ©</b> &nbsp;|&nbsp; Ø´Ù‡Ø±: <b>{{ current_month }}</b> &nbsp;|&nbsp; Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ: <b>2026/2025Ù…</b></p>
    </div>
    <div class="align-right">Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ / ÙŠØ¹ØªÙ…Ø¯ØŒ Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</div>

    <div class="section-header">Ø£ÙˆÙ„Ø§Ù‹: Ù…ØªØ§Ø¨Ø¹Ø© ØªØ³Ù„ÙŠÙ… Ø§Ù„Ù‚ÙŠØ§Ø¯Ø© Ø§Ù„ÙˆØ³Ø·Ù‰ (Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª/Ù…Ø­Ø§Ø¶Ø± Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹Ø§Øª/Ø§Ù„Ø®Ø·Ø©)</div>
    <table>
        <thead>
            <tr>
                <th rowspan="2">Ø§Ù„Ù‚Ø³Ù…</th>
                <th colspan="3">Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ù‚ÙŠØ§Ø¯Ø© Ø§Ù„Ø¹Ù„ÙŠØ§ Ù„Ù„Ù‚ÙŠØ§Ø¯Ø© Ø§Ù„ÙˆØ³Ø·Ù‰</th>
                <th rowspan="2">Ø£Ø³Ø¨Ø§Ø¨ Ø¹Ø¯Ù… Ø§Ù„ØªØ³Ù„ÙŠÙ…</th>
            </tr>
            <tr>
                <th>Ø¹Ø¯Ø¯ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø±Ø§Øª Ø§Ù„Ù…Ù†ÙØ°Ø©</th>
                <th>Ù…Ø­Ø¶Ø± Ø§Ø¬ØªÙ…Ø§Ø¹</th>
                <th>Ø®Ø·Ø© Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©</th>
            </tr>
        </thead>
        <tbody>
            {% for item in tracking %}
            <tr>
                <td class="align-right">{{ depts[item.department] }}</td>
                <td>{{ item.visit_forms_count }}</td>
                <td>{{ 'âœ“' if item.has_meeting_minutes else 'âœ—' }}</td>
                <td>{{ 'âœ“' if item.has_weekly_plan else 'âœ—' }}</td>
                <td>{{ item.reason_for_missing }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <div class="section-header">Ø«Ø§Ù†ÙŠØ§Ù‹: Ø¹Ø¯Ø¯ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„ØªÙŠ Ù†ÙØ°Øª</div>
    <p>1- Ø§Ù„Ù‚ÙŠØ§Ø¯Ø© Ø§Ù„Ø¹Ù„ÙŠØ§ = <b>{{ senior_visits_count }}</b> &nbsp;&nbsp;&nbsp;&nbsp; 2- Ø§Ù„Ù‚ÙŠØ§Ø¯Ø© Ø§Ù„ÙˆØ³Ø·Ù‰ = <b>{{ middle_visits_count }}</b></p>

    <div class="section-header">Ø«Ø§Ù„Ø«Ø§Ù‹: Ø¨ÙŠØ§Ù† Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ† Ø§Ù„Ù…ÙØ²Ø§Ø±ÙŠÙ† Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ù‚ÙŠØ§Ø¯Ø© Ø§Ù„Ø¹Ù„ÙŠØ§ ÙˆØ§Ù„ÙˆØ³Ø·Ù‰</div>
    <table>
        <thead>
            <tr>
                <th>Øª</th>
                <th>Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…</th>
                <th>Ø§Ù„Ù‚Ø³Ù…</th>
                <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø²ÙŠØ§Ø±Ø©</th>
                <th>ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø²ÙŠØ§Ø±Ø©</th>
                <th>Ø§Ø³Ù… Ø§Ù„Ø²Ø§Ø¦Ø±</th>
            </tr>
        </thead>
        <tbody>
            {% for visit in visits %}
            <tr>
                <td>{{ loop.index }}</td>
                <td class="align-right">{{ visit.teacher.name }}</td>
                <td>{{ depts[visit.teacher.department] }}</td>
                <td>{{ visit.date.strftime('%Y-%m-%d') }}</td>
                <td>{{ ratings[visit.rating] }}</td>
                <td>{{ visit.visitor_name }} <br><span style="font-size:9px;">({{ roles[visit.visitor_role] }})</span></td>
            </tr>
            {% else %}
            <tr><td colspan="6">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø²ÙŠØ§Ø±Ø§Øª Ù…Ø³Ø¬Ù„Ø©</td></tr>
            {% endfor %}
            <tr>
                <td colspan="6" style="background:#eee;"><b>Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„ÙƒÙ„ÙŠØ© = {{ visits|length }}</b></td>
            </tr>
        </tbody>
    </table>

    <div class="section-header">Ø±Ø§Ø¨Ø¹Ø§Ù‹: Ø¹Ø¯Ø¯ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„ØµÙÙŠØ© ÙˆØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„ØµÙÙŠ</div>
    <table>
        <thead>
            <tr>
                <th rowspan="2">Ù…</th>
                <th rowspan="2">Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠØ©</th>
                <th rowspan="2">Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª</th>
                <th colspan="4">Ù…Ø³ØªÙˆÙŠØ§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡</th>
            </tr>
            <tr>
                <th>ÙŠÙÙˆÙ‚ Ø§Ù„ØªÙˆÙ‚Ø¹Ø§Øª Ø¨ÙƒØ«ÙŠØ±</th>
                <th>ÙŠÙÙˆÙ‚ Ø§Ù„ØªÙˆÙ‚Ø¹Ø§Øª</th>
                <th>ÙŠÙÙŠ Ø¨Ø§Ù„ØªÙˆÙ‚Ø¹Ø§Øª</th>
                <th>ÙŠÙÙŠ Ø¬Ø²Ø¦ÙŠØ§Ù‹</th>
            </tr>
        </thead>
        <tbody>
            {% for stat in stats %}
            <tr>
                <td>{{ loop.index }}</td>
                <td class="align-right">{{ stat['name'] }}</td>
                <td>{{ stat['total'] }}</td>
                <td>{{ stat['exceeds_lot'] }}</td>
                <td>{{ stat['exceeds'] }}</td>
                <td>{{ stat['meets'] }}</td>
                <td>{{ stat['partial'] }}</td>
            </tr>
            {% endfor %}
            <tr style="background:#f2f2f2; font-weight:bold;">
                <td colspan="2">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙƒÙ„ÙŠ</td>
                <td>{{ total_stats['total'] }}</td>
                <td>{{ total_stats['exceeds_lot'] }}</td>
                <td>{{ total_stats['exceeds'] }}</td>
                <td>{{ total_stats['meets'] }}</td>
                <td>{{ total_stats['partial'] }}</td>
            </tr>
        </tbody>
    </table>

    <div style="page-break-after: always;"></div>

    <div class="section-header">Ø³Ø§Ø¯Ø³Ø§Ù‹: Ø­ØµØ± Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ† Ø§Ù„Ù…ØªÙ…ÙŠØ²ÙŠÙ† (ÙŠÙÙˆÙ‚ Ø§Ù„ØªÙˆÙ‚Ø¹Ø§Øª Ø¨ÙƒØ«ÙŠØ±)</div>
    <table>
        <thead>
            <tr>
                <th>Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…</th>
                <th>Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠ</th>
                <th>Ø§Ù„ØªÙ‚Ø¯ÙŠØ±</th>
            </tr>
        </thead>
        <tbody>
            {% for v in distinguished %}
            <tr>
                <td class="align-right">{{ v.teacher.name }}</td>
                <td>{{ depts[v.teacher.department] }}</td>
                <td>{{ ratings[v.rating] }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <div class="section-header">Ø­ØµØ± Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ† Ø§Ù„Ø£ÙˆÙ„Ù‰ Ø¨Ø§Ù„Ø±Ø¹Ø§ÙŠØ© (ÙŠÙÙŠ Ø¬Ø²Ø¦ÙŠØ§Ù‹)</div>
    <table>
        <thead>
            <tr>
                <th>Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…</th>
                <th>Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠ</th>
                <th>Ø§Ù„Ù…Ø¨Ø±Ø±Ø§Øª (Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª)</th>
            </tr>
        </thead>
        <tbody>
            {% for v in needs_support %}
            <tr>
                <td class="align-right">{{ v.teacher.name }}</td>
                <td>{{ depts[v.teacher.department] }}</td>
                <td>{{ v.notes }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <div class="section-header">Ø³Ø§Ø¨Ø¹Ø§Ù‹: Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù†ÙˆØ¹ÙŠ (Ø¬ÙˆØ§Ù†Ø¨ Ø§Ù„Ù‚ÙˆØ© ÙˆØ§Ù„ØªØ·ÙˆÙŠØ±)</div>
    <table>
        <thead>
            <tr>
                <th>Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠ</th>
                <th>Ø¬ÙˆØ§Ù†Ø¨ Ø§Ù„Ù‚ÙˆØ©</th>
                <th>Ø¬ÙˆØ§Ù†Ø¨ Ø¨Ø­Ø§Ø¬Ø© Ø¥Ù„Ù‰ ØªØ·ÙˆÙŠØ±</th>
            </tr>
        </thead>
        <tbody>
            {% for q in qualitative %}
            <tr>
                <td class="align-right">{{ depts[q.department] }}</td>
                <td>{{ q.strengths }}</td>
                <td>{{ q.improvements }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

</body>
</html>
"""

# ==========================================
# 4. Ù…Ù†Ø·Ù‚ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ (Routes)
# ==========================================

@app.route('/')
def dashboard():
    teachers = Teacher.query.all()
    return render_template_string(DASHBOARD_TEMPLATE, teachers=teachers, roles=ROLES, ratings=RATINGS, depts=DEPARTMENTS)

@app.route('/add_visit', methods=['POST'])
def add_visit():
    teacher_id = request.form.get('teacher_id')
    visit = Visit(
        visitor_name=request.form.get('visitor_name'),
        visitor_role=request.form.get('visitor_role'),
        teacher_id=teacher_id,
        date=datetime.strptime(request.form.get('date'), '%Y-%m-%d'),
        rating=int(request.form.get('rating')),
        notes=request.form.get('notes')
    )
    # ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª ÙÙŠ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©
    teacher = Teacher.query.get(teacher_id)
    tracking = MiddleLeadershipTracking.query.filter_by(department=teacher.department).first()
    if tracking and request.form.get('visitor_role') == 'SENIOR_T':
        tracking.visit_forms_count += 1
    
    db.session.add(visit)
    db.session.commit()
    return redirect(url_for('dashboard'))

@app.route('/report')
def report_view():
    # 1. Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©
    tracking = MiddleLeadershipTracking.query.all()
    
    # 2. Ø¬Ù„Ø¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª Ù…Ø±ØªØ¨Ø©
    visits = Visit.query.join(Teacher).order_by(Visit.visitor_role, Visit.date).all()
    
    # Ø­Ø³Ø§Ø¨ Ø¹Ø¯Ø¯ Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù‚ÙŠØ§Ø¯Ø© Ø§Ù„Ø¹Ù„ÙŠØ§ ÙˆØ§Ù„ÙˆØ³Ø·Ù‰ 
    senior_visits = Visit.query.filter(Visit.visitor_role.in_(['PRINCIPAL', 'ASST_PRIN'])).count()
    middle_visits = Visit.query.filter(Visit.visitor_role == 'SENIOR_T').count()

    # 3. Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù„Ù„Ø£Ù‚Ø³Ø§Ù… 
    stats = []
    total_stats = {'total': 0, 'exceeds_lot': 0, 'exceeds': 0, 'meets': 0, 'partial': 0}
    
    for code, name in DEPARTMENTS.items():
        dept_visits = Visit.query.join(Teacher).filter(Teacher.department == code).all()
        row = {
            'name': name,
            'total': len(dept_visits),
            'exceeds_lot': sum(1 for v in dept_visits if v.rating == 4),
            'exceeds': sum(1 for v in dept_visits if v.rating == 3),
            'meets': sum(1 for v in dept_visits if v.rating == 2),
            'partial': sum(1 for v in dept_visits if v.rating == 1),
        }
        stats.append(row)
        # ØªØ¬Ù…ÙŠØ¹ Ø§Ù„ÙƒÙ„ÙŠ
        total_stats['total'] += row['total']
        total_stats['exceeds_lot'] += row['exceeds_lot']
        total_stats['exceeds'] += row['exceeds']
        total_stats['meets'] += row['meets']
        total_stats['partial'] += row['partial']

    # 4. Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ† Ø§Ù„Ù…ØªÙ…ÙŠØ²ÙŠÙ† ÙˆØ§Ù„Ø£ÙˆÙ„Ù‰ Ø¨Ø§Ù„Ø±Ø¹Ø§ÙŠØ©
    distinguished = Visit.query.filter_by(rating=4).join(Teacher).all()
    needs_support = Visit.query.filter_by(rating=1).join(Teacher).all()

    # 5. Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù†ÙˆØ¹ÙŠ
    qualitative = QualitativeReport.query.all()

    return render_template_string(REPORT_TEMPLATE,
                                  tracking=tracking,
                                  visits=visits,
                                  stats=stats,
                                  total_stats=total_stats,
                                  senior_visits_count=senior_visits,
                                  middle_visits_count=middle_visits,
                                  distinguished=distinguished,
                                  needs_support=needs_support,
                                  qualitative=qualitative,
                                  depts=DEPARTMENTS, ratings=RATINGS, roles=ROLES,
                                  current_month=datetime.now().strftime("%B"))

# Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Setup)
@app.route('/setup')
def setup_data():
    with app.app_context():
        db.create_all()
        
        # Ø¥Ø¶Ø§ÙØ© Ø£Ù‚Ø³Ø§Ù… Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø©
        if not MiddleLeadershipTracking.query.first():
            for code in DEPARTMENTS.keys():
                db.session.add(MiddleLeadershipTracking(department=code))
                db.session.add(QualitativeReport(department=code, strengths="ÙŠÙˆØ¬Ø¯ ØªØ¹Ø§ÙˆÙ† Ù…Ù„Ø­ÙˆØ¸", improvements="Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„ØªØ­ØµÙŠÙ„"))
        
        # Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ù„Ù…ÙŠÙ† ØªØ¬Ø±ÙŠØ¨ÙŠÙŠÙ†
        if not Teacher.query.first():
            db.session.add(Teacher(name="Ø£Ø­Ù…Ø¯ Ù…Ø­Ù…Ø¯", department="MATH_SC"))
            db.session.add(Teacher(name="Ø³Ø§Ø±Ø© Ø¹Ù„ÙŠ", department="AR"))
            db.session.add(Teacher(name="Ù…Ø­Ù…ÙˆØ¯ Ø­Ø³Ù†", department="ENG"))
        
        db.session.commit()
    return redirect(url_for('dashboard'))

if __name__ == '__main__':
    # Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„
    with app.app_context():
        db.create_all()
    app.run(debug=True)